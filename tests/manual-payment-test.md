# 手動決済フローテスト手順

## テスト準備

### 1. 環境確認
```bash
# 開発サーバー起動
npm run dev

# Stripe CLI でWebhook転送開始
stripe listen --forward-to localhost:3000/api/stripe/webhook
```

### 2. テスト用カード情報
```
カード番号: 4242 4242 4242 4242
有効期限: 12/34 (任意の将来の日付)
CVC: 123 (任意の3桁)
郵便番号: 10001 (任意)
```

## テストシナリオ1: 新規ユーザーのアップグレード

### ステップ1: アカウント作成
1. http://localhost:3000 にアクセス
2. 「無料で始める」ボタンをクリック
3. 新規アカウント作成:
   - メール: test@example.com
   - パスワード: testpassword123

### ステップ2: 無料プランでメモ作成
1. `/app` ページでメモを3つ作成
2. 4つ目のメモ作成時に制限メッセージ確認

### ステップ3: アップグレード実行
1. 「プランをアップグレード」ボタンをクリック
2. `/billing` ページに遷移
3. 「Proプランにアップグレード」ボタンをクリック

### ステップ4: Stripe Checkout
1. Stripe Checkoutページに自動遷移
2. テストカード情報入力:
   ```
   メール: test@example.com
   カード番号: 4242 4242 4242 4242
   有効期限: 12/34
   CVC: 123
   郵便番号: 10001
   ```
3. 「支払う」ボタンをクリック

### ステップ5: 決済完了確認
1. `/success` ページに自動遷移
2. 「アップグレード完了」メッセージ確認
3. 「メモを作成する」をクリック

### ステップ6: プラン変更確認
1. `/app` ページで無制限メモ作成可能を確認
2. `/billing` ページでProプラン表示確認

## テストシナリオ2: 決済キャンセル

### ステップ1-3: 上記と同じ

### ステップ4: Stripe Checkoutでキャンセル
1. Stripe Checkoutページで「戻る」ボタンクリック
2. または、ブラウザの戻るボタン使用

### ステップ5: キャンセル確認
1. `/cancel` ページに遷移
2. 「決済がキャンセルされました」メッセージ確認
3. 「再度アップグレード」リンク確認

## テストシナリオ3: サブスクリプション管理

### 前提条件
- Proプランにアップグレード済み

### ステップ1: Customer Portal アクセス
1. `/billing` ページにアクセス
2. 「サブスクリプション管理」ボタンクリック
3. Stripe Customer Portalに遷移

### ステップ2: Portal機能確認
1. 支払い方法の変更
2. 請求書ダウンロード
3. サブスクリプションキャンセル

## テストシナリオ4: Webhook動作確認

### ステップ1: Webhook監視
```bash
# 別ターミナルで実行
stripe listen --print-json
```

### ステップ2: イベント確認
決済完了後、以下のイベントを確認:
- `checkout.session.completed`
- `customer.subscription.created`
- `invoice.payment_succeeded`

### ステップ3: データベース確認
Supabaseダッシュボードで:
1. `profiles` テーブル確認
   - `stripe_customer_id` が設定
   - `plan` が 'pro' に更新
   - `subscription_status` が 'active'

## エラーケーステスト

### テスト1: カード拒否
```
カード番号: 4000 0000 0000 0002
結果: カードが拒否されました
```

### テスト2: 残高不足
```
カード番号: 4000 0000 0000 9995
結果: 残高不足エラー
```

### テスト3: 3D Secure認証
```
カード番号: 4000 0027 6000 3184
結果: 追加認証が必要
```

## 確認ポイントチェックリスト

### 決済前
- [ ] 無料プランで3メモ制限が機能
- [ ] アップグレードボタンが表示
- [ ] 料金プラン情報が正確

### 決済中
- [ ] Stripe Checkoutに正常遷移
- [ ] テストモード表示確認
- [ ] 価格が¥500/月と表示

### 決済後
- [ ] 成功ページに遷移
- [ ] プランがProに更新
- [ ] 無制限メモ作成可能
- [ ] Webhookイベント受信
- [ ] データベース更新確認

### キャンセル時
- [ ] キャンセルページに遷移
- [ ] プランは無料のまま
- [ ] 再度アップグレード可能

## デバッグ用コマンド

```bash
# Stripeイベント確認
stripe events list

# 特定のイベント詳細
stripe events retrieve evt_xxxxx

# サブスクリプション確認
stripe subscriptions list

# 顧客情報確認
stripe customers list

# ログ確認
tail -f .next/server/logs/*
```

## トラブルシューティング

### 問題: Checkoutページに遷移しない
- 環境変数確認: `STRIPE_PRICE_ID`
- APIキー確認: `STRIPE_SECRET_KEY`
- ブラウザコンソールでエラー確認

### 問題: Webhookが受信されない
- Stripe CLI起動確認
- 署名シークレット確認: `STRIPE_WEBHOOK_SECRET`
- ポート3002が正しいか確認

### 問題: プランが更新されない
- Webhookハンドラーのログ確認
- Supabase接続確認
- データベーススキーマ確認